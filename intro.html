
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Getting started with Non-Linear Least-Squares Fitting &mdash; Non-Linear Least-Squares Minimization and Curve-Fitting for Python</title>
    
    <link rel="stylesheet" href="_static/lmfitdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.8.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Non-Linear Least-Squares Minimization and Curve-Fitting for Python" href="index.html" />
    <link rel="next" title="Downloading and Installation" href="installation.html" />
    <link rel="prev" title="Non-Linear Least-Square Minimization and Curve-Fitting for Python" href="index.html" />
  <script type="text/x-mathjax-config">
     MathJax.Hub.Config({
        "TeX": {Macros: {AA : "{\\unicode{x212B}}"}},
        "HTML-CSS": {scale: 90}
  });</script>

  </head>
  <body>
<div>
<table border=0>
  <tr><td></td><td width=75% padding=5 align=left>
       <a href="index.html" style="color: #157"> <font size=+3>LMFIT</font></a>
     </td><td></td>
     <td width=8% align=left>
         <a href="contents.html" style="color: #882222">
         <font size+=1>Contents</font></a> </td>
     <td width=8% align=left>
          <a href="installation.html" style="color: #882222">
          <font size+=1>Download</font></a></td>
     <td width=8% align=left>
        <a href="https://github.com/lmfit/lmfit-py/" style="color: #882222">
         <font size+=1>Develop</font></a></td>
  </tr>
  <tr><td></td><td width=75% padding=5 align=left>
        <a href="index.html" style="color: #157"> <font size=+2>
	Non-Linear Least-Squares Minimization and Curve-Fitting for Python</font></a>
     </td><td></td>
     <td width=8% align=left>
         <a href="intro.html" style="color: #882222">
         <font size+=1>Introduction</font></a> </td>
     <td width=8% align=left>
         <a href="parameters.html" style="color: #882222">
         <font size+=1>Parameters</font></a> </td>
     <td width=8% align=left>
         <a href="model.html" style="color: #882222">
         <font size+=1>Models</font></a> </td>

  </tr>
</table>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="installation.html" title="Downloading and Installation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Non-Linear Least-Square Minimization and Curve-Fitting for Python"
             accesskey="P">previous</a> |</li>
   <li>[<a href="#">intro</a>|</li>
   <li><a href="parameters.html">parameters</a>|</li>
   <li><a href="fitting.html"> minimize</a>|</li>
   <li><a href="model.html"> model</a>|</li>
   <li><a href="builtin_models.html"> builtin models</a>|</li>
   <li><a href="confidence.html">confidence intervals</a>|</li>
   <li><a href="bounds.html">bounds</a>|</li>
   <li><a href="constraints.html">constraints</a>]</li>
 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Non-Linear Least-Square Minimization and Curve-Fitting for Python</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="installation.html"
                        title="next chapter">Downloading and Installation</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/intro.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="getting-started-with-non-linear-least-squares-fitting">
<span id="intro-chapter"></span><h1>Getting started with Non-Linear Least-Squares Fitting<a class="headerlink" href="#getting-started-with-non-linear-least-squares-fitting" title="Permalink to this headline">Â¶</a></h1>
<p>The lmfit package is designed to provide simple tools to help you build of
complex fitting models for non-linear least-squares problems and apply
these models to real data.  This section gives an overview of the concepts
and describes how to set up and perform simple fits.  Some basic knowledge
of Python, numpy, and modeling data are assumed.</p>
<p>To do a non-linear least-squares fit of a model to data or for a variety of other
optimization problems, the main task is to write an <em>objective function</em>
that takes the values of the fitting variables and calculates either a
scalar value to be minimized or an array of values that is to be minimized
in the least-squares sense.   For many data fitting processes, the
least-squares approach is used, and the objective function should
return an array of (data-model), perhaps scaled by some weighting factor
such as the inverse of the uncertainty in the data.  For such a problem,
the chi-square (<span class="math">\(\chi^2\)</span>) statistic is often defined as:</p>
<div class="math">
\[\chi^2 =  \sum_i^{N} \frac{[y^{\rm meas}_i - y_i^{\rm model}({\bf{v}})]^2}{\epsilon_i^2}\]</div>
<p>where <span class="math">\(y_i^{\rm meas}\)</span> is the set of measured data, <span class="math">\(y_i^{\rm
model}({\bf{v}})\)</span> is the model calculation, <span class="math">\({\bf{v}}\)</span> is the set of
variables in the model to be optimized in the fit, and <span class="math">\(\epsilon_i\)</span>
is the estimated uncertainty in the data.</p>
<p>In a traditional non-linear fit, one writes an objective function that takes the
variable values and calculates the residual <span class="math">\(y^{\rm meas}_i -
y_i^{\rm model}({\bf{v}})\)</span>, or the residual scaled by the data
uncertainties, <span class="math">\([y^{\rm meas}_i - y_i^{\rm
model}({\bf{v}})]/{\epsilon_i}\)</span>, or some other weighting factor.  As a
simple example, one might write an objective function like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">residual</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">eps_data</span><span class="p">):</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">phaseshift</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">decay</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">freq</span>  <span class="o">+</span> <span class="n">phaseshift</span><span class="p">)</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">decay</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">/</span><span class="n">eps_data</span>
</pre></div>
</div>
<p>To perform the minimization with <a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/optimize.html#module-scipy.optimize" title="(in SciPy v0.15.1)"><tt class="xref py py-mod docutils literal"><span class="pre">scipy.optimize</span></tt></a>, one would do:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">leastsq</span>
<span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.007</span><span class="p">]</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">eps_data</span><span class="p">))</span>
</pre></div>
</div>
<p>Though it is wonderful to be able to use python for such optimization
problems, and the scipy library is robust and easy to use, the approach
here is not terribly different from how one would do the same fit in C or
Fortran.  There are several practical challenges to using this approach,
including:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>The user has to keep track of the order of the variables, and their
meaning &#8211; vars[0] is the amplitude, vars[2] is the frequency, and so
on, although there is no intrinsic meaning to this order.</li>
<li>If the user wants to fix a particular variable (<em>not</em> vary it in the
fit), the residual function has to be altered to have fewer variables,
and have the corresponding constant value passed in some other way.
While reasonable for simple cases, this quickly becomes a significant
work for more complex models, and greatly complicates modeling for
people not intimately familiar with the details of the fitting code.</li>
<li>There is no simple, robust way to put bounds on values for the
variables, or enforce mathematical relationships between the
variables.  In fact, those optimization methods that do provide
bounds, require bounds to be set for all variables with separate
arrays that are in the same arbitrary order as variable values.
Again, this is acceptable for small or one-off cases, but becomes
painful if the fitting model needs to change.</li>
</ol>
</div></blockquote>
<p>These shortcomings are really do solely to the use of traditional arrays of
variables, as matches closely the implementation of the Fortran code.  The
lmfit module overcomes these shortcomings by using a core reason for using
Python &#8211; objects.  The key concept for lmfit is to use <a class="reference internal" href="parameters.html#Parameter" title="Parameter"><tt class="xref py py-class docutils literal"><span class="pre">Parameter</span></tt></a>
objects instead of plain floating point numbers as the variables for the
fit.  By using <a class="reference internal" href="parameters.html#Parameter" title="Parameter"><tt class="xref py py-class docutils literal"><span class="pre">Parameter</span></tt></a> objects (or the closely related
<a class="reference internal" href="parameters.html#Parameters" title="Parameters"><tt class="xref py py-class docutils literal"><span class="pre">Parameters</span></tt></a> &#8211; a dictionary of <a class="reference internal" href="parameters.html#Parameter" title="Parameter"><tt class="xref py py-class docutils literal"><span class="pre">Parameter</span></tt></a> objects), one can</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>not care about the order of variables, but refer to Parameters
by meaningful names.</li>
<li>place bounds on Parameters as attributes, without worrying about order.</li>
<li>fix Parameters, without having to rewrite the objective function.</li>
<li>place algebraic constraints on Parameters.</li>
</ol>
</div></blockquote>
<p>To illustrate the value of this approach, we can rewrite the above example
as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">Parameters</span>

<span class="k">def</span> <span class="nf">residual</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">eps_data</span><span class="p">):</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;amp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">pshift</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;phase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;frequency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">decay</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;decay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">freq</span>  <span class="o">+</span> <span class="n">pshift</span><span class="p">)</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">decay</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">/</span><span class="n">eps_data</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
<span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;amp&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;decay&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.007</span><span class="p">)</span>
<span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;phase&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">eps_data</span><span class="p">))</span>
</pre></div>
</div>
<p>At first look, we simply replaced a list of values with a dictionary,
accessed by name &#8211; not a huge improvement.  But each of the named
<a class="reference internal" href="parameters.html#Parameter" title="Parameter"><tt class="xref py py-class docutils literal"><span class="pre">Parameter</span></tt></a> in the <a class="reference internal" href="parameters.html#Parameters" title="Parameters"><tt class="xref py py-class docutils literal"><span class="pre">Parameters</span></tt></a> object hold additional
attributes to modify the value during the fit.  For example, Parameters can
be fixed or bounded.  This can be done when being defined:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
<span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;amp&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;decay&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.007</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;phase&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>(where <tt class="docutils literal"><span class="pre">vary=False</span></tt> will prevent the value from changing in the fit, and
<tt class="docutils literal"><span class="pre">min=-0.0</span></tt> will set a lower bound on that parameters value) or after
being defined by setting the corresponding attributes after they have been
created:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">params</span><span class="p">[</span><span class="s">&#39;amp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">params</span><span class="p">[</span><span class="s">&#39;decay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="mf">0.10</span>
</pre></div>
</div>
<p>Importantly, our function to be minimized remains unchanged.</p>
<p>The <cite>params</cite> object can be copied and modified to make many user-level
changes to the model and fitting process.  Of course, most of the
information about how your data is modeled goes into the objective
function, but the approach here allows some external control, that is by
the <strong>user</strong> of the objective function instead of just by the author of the
objective function.</p>
<p>Finally, in addition to the <a class="reference internal" href="parameters.html#Parameters" title="Parameters"><tt class="xref py py-class docutils literal"><span class="pre">Parameters</span></tt></a> approach to fitting data,
lmfit allows you to easily switch optimization methods without rewriting
your objective function, and provides tools for writing fitting reports and
for better determining the confidence levels for Parameters.</p>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="installation.html" title="Downloading and Installation"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Non-Linear Least-Square Minimization and Curve-Fitting for Python"
             >previous</a> |</li>
   <li>[<a href="#">intro</a>|</li>
   <li><a href="parameters.html">parameters</a>|</li>
   <li><a href="fitting.html"> minimize</a>|</li>
   <li><a href="model.html"> model</a>|</li>
   <li><a href="builtin_models.html"> builtin models</a>|</li>
   <li><a href="confidence.html">confidence intervals</a>|</li>
   <li><a href="bounds.html">bounds</a>|</li>
   <li><a href="constraints.html">constraints</a>]</li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Matthew Newville, The University of Chicago,  Till Stensitzki, Freie Universitat Berlin.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>